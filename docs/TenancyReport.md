# Tenancy Report

## Overview
- **Middleware entry:** `App\Core\Tenancy\Middleware\IdentifyTenant` resolves the tenant by primary domain, cached aliases, or configured local fallback and wires the resolved company into the container and request attributes while synchronising Spatie team scopes.【F:app/Core/Tenancy/Middleware/IdentifyTenant.php†L5-L87】
- **Global scope:** `App\Core\Tenancy\Scopes\CompanyScope` ensures all tenant-aware models query with the active `company_id` coming from the HTTP request or bound company instance.【F:app/Core/Tenancy/Scopes/CompanyScope.php†L5-L32】
- **Model trait:** `App\Core\Tenancy\Traits\BelongsToCompany` applies the scope, auto-fills `company_id` during creation, and exposes the `company` relation.【F:app/Core/Tenancy/Traits/BelongsToCompany.php†L5-L28】
- **Helpers:** `currentCompanyId()` and `tenant()` continue to expose the resolved tenant for legacy callers.【F:app/Support/helpers.php†L1-L35】

## Tenant vs Global Tables
| Scope | Tables |
| --- | --- |
| **Global** | `companies`, `company_domains`, `users` (authentication metadata), Spatie permission tables, framework tables (`migrations`, `jobs`, `cache`).【F:database/migrations/2024_01_01_000100_create_companies_table.php†L1-L27】【F:database/migrations/2024_01_01_000300_create_company_domains_table.php†L12-L24】【F:database/migrations/2024_01_01_000200_add_company_id_to_users_table.php†L15-L65】【F:database/migrations/2025_10_11_180831_create_permission_tables.php†L13-L108】 |
| **Tenant** | All module tables under `app/Modules/**/Database/migrations` include a required `company_id` with cascaded FK and composite indexes. Examples: products, warehouses, customers, orders, shipments, invoices, purchase orders, work orders, media assets.【F:app/Modules/Inventory/Database/migrations/2024_01_01_000500_create_products_table.php†L12-L33】【F:app/Modules/Inventory/Database/migrations/2024_01_02_000300_create_warehouses_table.php†L12-L24】【F:app/Modules/Marketing/Database/migrations/2024_01_01_000700_create_orders_table.php†L13-L28】【F:app/Modules/Logistics/Database/migrations/2024_01_01_000800_create_shipments_table.php†L12-L32】【F:app/Modules/Finance/Database/migrations/2025_01_01_030000_create_invoices_table.php†L12-L37】【F:app/Modules/Procurement/Database/migrations/2025_01_12_000000_create_ap_invoices_table.php†L12-L35】【F:app/Modules/Production/Database/migrations/2025_01_05_000000_create_work_orders_table.php†L12-L32】【F:app/Modules/Drive/Database/migrations/2024_01_01_000400_create_media_table.php†L12-L33】 |

> **Not:** `2025_02_01_000100_enforce_company_scoping.php` migrationı tenant tablolarında `company_id` indekslerini doğrular ve null olmayan kısıtları yalnızca veri temizse sıkılaştırır, böylece dağıtım sırasında risk oluşturmadan tutarlılığı sağlar.【F:database/migrations/2025_02_01_000100_enforce_company_scoping.php†L1-L77】  `2025_10_11_190000_align_permission_team_scope.php` ise Spatie pivot tablolarına `company_id` sütunlarını ekleyip birincil anahtarları `company_id` ile genişleterek yetkilerin şirket bazlı ayrışmasını garanti eder.【F:database/migrations/2025_10_11_190000_align_permission_team_scope.php†L1-L64】

## Model Matrix
| Model | Table | `company_id` | Index / Unique | Relationships | Recommendation |
| --- | --- | --- | --- | --- | --- |
| `App\Modules\Inventory\Domain\Models\Product` | `products` | Required FK (`->constrained()`), auto-set by trait | Unique `company_id+sku`, indexes on status and media references【F:app/Modules/Inventory/Database/migrations/2024_01_01_000500_create_products_table.php†L12-L33】 | Belongs to media, category, unit; has many variants, gallery, stock records.【F:app/Modules/Inventory/Domain/Models/Product.php†L7-L74】 | Continue using trait; consider future observers to cascade `company_id` to related stock movements during manual inserts. |
| `App\Modules\Marketing\Domain\Models\Customer` | `customers` | Required | Unique `company_id+code` and `company_id+email`; indexes on status segments via requests.【F:app/Modules/Marketing/Database/migrations/2024_01_01_000600_create_customers_table.php†L12-L28】 | Has addresses, contacts, orders.【F:app/Modules/Marketing/Domain/Models/Customer.php†L13-L62】 | Ensure legacy CRM controllers switch to `module=Marketing` namespace when migrated. |
| `App\Modules\Marketing\Domain\Models\Order` | `orders` | Required | Unique `company_id+order_no`; indexes on customer/status.【F:app/Modules/Marketing/Database/migrations/2024_01_01_000700_create_orders_table.php†L13-L28】 | Belongs to customer, has many lines & activities.【F:app/Modules/Marketing/Domain/Models/Order.php†L12-L66】 | When porting to Marketing module, reuse trait and ensure request validation stays tenant-scoped. |
| `App\Modules\Logistics\Domain\Models\Shipment` | `shipments` | Required | Unique `company_id+shipment_no`; status indexes.【F:app/Modules/Logistics/Database/migrations/2024_01_01_000800_create_shipments_table.php†L12-L32】 | Belongs to order and warehouse; has lines.【F:app/Modules/Logistics/Domain/Models/Shipment.php†L12-L74】 | Add composite FK validations when logistics module moves to consoles orchestration. |
| `App\Modules\Finance\Domain\Models\Invoice` | `invoices` | Required | Unique `company_id+invoice_no`; indexes for customer/status/date.【F:app/Modules/Finance/Database/migrations/2025_01_01_030000_create_invoices_table.php†L12-L37】 | Belongs to customer/order; has lines, receipts, allocations.【F:app/Modules/Finance/Domain/Models/Invoice.php†L13-L80】 | Extend trait usage across AP models and ensure audit trail respects tenant scope. |
| `App\Modules\Procurement\Domain\Models\PurchaseOrder` | `purchase_orders` | Required | Unique `company_id+po_number`; indexes on vendor/date.【F:database/migrations/2025_02_15_000020_add_number_columns_to_documents.php†L8-L47】 | Has lines, GRNs, vendor relation.【F:app/Modules/Procurement/Domain/Models/PurchaseOrder.php†L10-L54】 | Add composite unique on `company_id+vendor_reference` when migrating historical data. |
| `App\Modules\Production\Domain\Models\WorkOrder` | `work_orders` | Required | Unique `company_id+work_order_no`; indexes on status.【F:app/Modules/Production/Database/migrations/2025_01_05_000000_create_work_orders_table.php†L12-L32】 | Belongs to product; has materials and receipts.【F:app/Modules/Production/Domain/Models/WorkOrder.php†L14-L79】 | Plan for composite FK enforcement in Komut 6 once BOM module lands. |
| `App\Modules\Drive\Domain\Models\Media` | `media` | Required | Indexed by `company_id`, category, importance.【F:app/Modules/Drive/Database/migrations/2024_01_01_000400_create_media_table.php†L12-L33】 | Belongs to uploader; cascade deletes clean disks.【F:app/Modules/Drive/Domain/Models/Media.php†L13-L78】 | During tenancy audit ensure purging script respects tenant-based storage directories. |

## Soft Delete Usage
Soft deletes remain on inventory (`products`, `warehouses`, `stock_items`), CRM (`customers`, `orders`, `quotes`), logistics (`shipments`), finance (`invoices`, `receipts`), production (`work_orders`), and drive (`media`). Migration plan: Komut 6 will consolidate purge policies; until then, audit command highlights rows with inconsistent `company_id` to avoid ghost data leaks.【F:app/Modules/Inventory/Database/migrations/2024_01_01_000500_create_products_table.php†L12-L33】【F:app/Modules/Marketing/Database/migrations/2024_01_01_000700_create_orders_table.php†L13-L28】【F:app/Modules/Logistics/Database/migrations/2024_01_01_000800_create_shipments_table.php†L12-L32】【F:app/Modules/Finance/Database/migrations/2025_01_01_030000_create_invoices_table.php†L12-L37】【F:app/Modules/Production/Database/migrations/2025_01_05_000000_create_work_orders_table.php†L12-L32】【F:app/Modules/Drive/Database/migrations/2024_01_01_000400_create_media_table.php†L12-L33】

## Risk Notes
- **Missing tenant binding:** Legacy controllers that bypass middleware must either manually run `IdentifyTenant` or bind the company; audit command flags `NULL company_id` records for remediation.【F:app/Core/Tenancy/Console/Commands/TenancyAuditCommand.php†L17-L71】
- **Cross-tenant relationships:** Heuristic join checks in the audit command detect rows where child `company_id` mismatches parent (e.g. `orders.customer_id`). Future phases can promote these warnings into database constraints once composite foreign keys are standardised.【F:app/Core/Tenancy/Console/Commands/TenancyAuditCommand.php†L73-L110】
- **Seeder scope:** `DatabaseSeeder` only runs tenant demo seeders in local/dev via env guard; production remains untouched.【F:database/seeders/DatabaseSeeder.php†L9-L29】
- **Permission catalogue:** `AccessServiceProvider` tenant id bağlamında merkezi izin sözlüğü ile modül configlerini birleştirip cache’i yönetiyor; `config/permissions.php` altında rol bazlı anahtarlar izleniyor.【F:app/Core/Providers/AccessServiceProvider.php†L5-L95】【F:config/permissions.php†L1-L47】

